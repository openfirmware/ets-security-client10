<!DOCTYPE html>
<html>
<head>
	<title>Secure Client Test</title>
	<style>
	body {
		max-width: 960px;
		margin: 0 auto;
		padding: 0 1em;
	}

	#url {
		margin-left: 1em;
		width: 60%;
	}

	#main {
		display: flex;
	}

	#functions {
		padding: 1em;
	}

	.output {
		border: 1px solid #000;
		max-width: 960px;
		padding: 1em;
	}

	.output pre {
		margin: 0;
		padding: 0;
	}
	</style>
</head>
<body>
	<p>This page emulates a secure client connecting to the test suite. It should be compatible with the SAML2 Browser SSO workflow.</p>
	<p><label for="url">Test Endpoint URL</label><input type="text" name="url" id="url" /></p>

	<h2>1. Get Public Capabilities</h2>

	<p>Issue a GET request to the Service Provider for the Capabilities.</p>

	<p><button id="get-public">Get Public Capabilities</button></p>

	<div class="output" id="log1">
	</div>

	<h2>2. Get Secure Capabilities</h2>

	<p>Issue a GET request to the Service Provider for the Secure Capabilities.</p>

	<p><button id="get-secure">Get Secure Capabilities</button></p>

	<div class="output" id="log2">
	</div>

	<h2>3. Get SSO</h2>

	<p>Issue a GET request to the Identity Provider for Single Sign-On.</p>

	<p><button id="get-sso">Get Single Sign-On</button></p>

	<div class="output" id="log3">
	</div>

	<h2>4. Get SSO, with Credentials</h2>

	<p>Issue a GET request to the Identity Provider for Single Sign-On, with SSO credentials.</p>

	<p><button id="get-sso-creds">Get Single Sign-On with Credentials</button></p>

	<div class="output" id="log4">
	</div>

	<h2>5. Post SAML Authentication Response</h2>

	<p>Issue a POST request to the Service Provider with the SAML Authentication Response.</p>

	<p><button id="post-saml">Post SAML Auth Response</button></p>

	<div class="output" id="log5">
	</div>

	<h2>6. Get Secure Capabilities with Security Context</h2>

	<p>Issue a GET request to the Service Provider for the Secure Capabilities using the security context from the previous response.</p>

	<p><button id="get-secure-creds">Get Secure Capabilities with Security Context</button></p>

	<div class="output" id="log6">
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>
		function de(ele) {
			$(ele).prop("disabled", true);
		}

		function ee(ele) {
			$(ele).prop("disabled", false);
		}

		function logRequest(target, settings) {
			let matches = settings.url.match(/https?:\/\/([^\/]+)(\/.+)/);
			let host = matches[1];
			let path = matches[2];
			$(target).append($("<pre></pre>").text(settings.type + " " + path + " " + "HTTP/1.1"));
			$(target).append($("<pre></pre>").text("Accept: " + settings.accepts["*"]));
			$(target).append($("<pre></pre>").text("Host: " + host));
			$(target).append($("<hr></hr>"));
			
		}

		function logResponse(target, xhr) {
			$(target).append($("<pre></pre>").text("HTTP/1.1 " + xhr.status + " " + xhr.statusText));
			$(target).append($("<pre></pre>").text(xhr.getAllResponseHeaders()));
			$(target).append($("<pre></pre>").text("\n" + xhr.responseText));
		}

		$(function() {
			de("button");

			let url;
			let responses = [];

			let nsPrefixes = {
				'ows': 'http://www.opengis.net/ows/1.1',
				'ows_security': 'http://www.opengis.net/security/1.0',
				'xlink': 'http://www.w3.org/1999/xlink'
			}

			function nsLookup(prefix){
				return nsPrefixes[prefix] || null;
			}

			$("#url").on("input", function() {
				url = this.value;

				(url === undefined || url === "") ? de("#get-public") : ee("#get-public");
			});

			$("#get-public").on("click", function() {
				de("#url, #get-public");

				$.ajax({
					url: url,
					data: {
						request: "GetCapabilities",
						service: "WMS"
					},
					dataType: "xml",
					beforeSend: function(xhr, settings) {
						logRequest("#log1", settings);
						return true;
					},
					success: function(data, status, xhr) {
						logResponse("#log1", xhr);
						responses.push(xhr.responseXML);
						ee("#get-secure");
					}
				});
			});

			$("#get-secure").on("click", function() {
				de("#get-secure");

				let doc = responses[0];
				let getElement = doc.evaluate("//ows_security:ExtendedSecurityCapabilities//ows:Operation[@name='GetCapabilities']//ows:Get", doc, nsLookup, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
				let secureURL = getElement.getAttribute("xlink:href");

				$.ajax({
					url: secureURL,
					data: {
						request: "GetCapabilities",
						service: "WMS"
					},
					dataType: "xml",
					beforeSend: function(xhr, settings) {
						logRequest("#log2", settings);
						return true;
					},
					success: function(data, status, xhr) {
						logResponse("#log2", xhr);
						responses.push(xhr.responseXML);
						ee("#get-sso");
					}
				});
			});

			$("#get-sso").on("click", function() {
				de("#get-sso");

				ee("#get-sso-creds");
			});

			$("#get-sso-creds").on("click", function() {
				de("#get-sso-creds");

				ee("#post-saml");
			});

			$("#post-saml").on("click", function() {
				de("#post-saml");

				ee("#get-secure-creds");
			});

			$("#get-secure-creds").on("click", function() {
				de("#get-secure-creds");

			});

			$(window).on("beforeunload", function() {
				return "Lose current state of test client?";
			})
		});
	</script>
</body>
</html>